<div class="jumbotron">
    <h1>Settings</h1>

    <h3>User Info</h3>
    <div class="container mb-5">
        <div class="row">
            <div class="col-6">
                <div class="row">
                    <div class="col">
                        First Name
                    </div>
                    <div class="col">
                        Last Name
                    </div>
                </div>
                <div class="row">
                    <div class="col my-2">
                        <input type="text" class="form-control border border-1 border-success" id="firstName" name="firstName" value="<%= user.firstName ?? '' %>" placeholder="first name">
                    </div>
                    <div class="col my-2">
                        <input type="text" class="form-control border border-1 border-success" id="lastName" name="lastName" value="<%= user.lastName ?? '' %>" placeholder="last name">
                    </div>
                </div>
            </div>
            <% if (isAdmin) { %>
                <div class="col">
                    <div class="row">
                        <div class="col-3">
                            semester
                        </div>
                        <div class="col-3">
                            code refresh rate
                        </div>
                        <div class="col-3">
                            code time start
                        </div>
                        <div class="col-3">
                            code time window
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-3">
                            <%- semestersDropdown %>
                        </div>
                        <div class="col-3">
                            <input class="form-control my-2" type="number" id="codeRefreshInput" value="<%- globalSettings.codeRefreshRate %>">
                        </div>
                        <div class="col-3">
                            <input class="form-control my-2" type="number" id="codeStartInput" value="<%- globalSettings.codeTimeStart %>">
                        </div>
                        <div class="col-3">
                            <input class="form-control my-2" type="number" id="codeWindowInput" value="<%- globalSettings.codeTimeWindow %>">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-9"></div>
                        <div class="col">
                            <button type="button" id="save-admin" class="btn btn-primary btn-sm my-2">save admin</button>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>


    <h3>Change Password</h3>
    <div class="container">
        <div class="row my-4">
            <div class="col-3">
                <input type="password" class="form-control" id="password" name="password" placeholder="current password">
            </div>
        </div>
        <div class="row my-4">
            <div class="col-3">
                <input type="password" class="form-control" id="newPassword" name="newPassword" placeholder="new password">
            </div>
        </div>
        <div class="row my-4">
            <div class="col-3">
                <input type="password" class="form-control" id="confirmedPassword" name="confirmedPassword" placeholder="confirm new password">
            </div>
        </div>
        <div class="row my-4">
            <div class="col-3">
                <button type="submit" class="btn btn-primary" id="submit">Submit</button>
            </div>
        </div>
    </div>
</div>

<script>
    var user = <%-JSON.stringify(user)%>

    $('#save-admin').click(e => {

        var codeRefresh = parseInt($('#codeRefreshInput').val());
        var codeStart = parseInt($('#codeStartInput').val());
        var codeWindow = parseInt($('#codeWindowInput').val());
        
        var data = {
            codeRefresh,
            codeStart,
            codeWindow,
        }

        $.ajax({
            url: `/user/${user.id}/settings/global`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                $('#toastHeader').html("Success");
                $('#toastBody').html(response.message);
                $('#liveToast').toast('show');
            },
            error: function(response) {
                $('#toastHeader').html("Error");
                $('#toastBody').html(response.message);
                $('#liveToast').toast('show');
            }
        });

    })

    $('#semester-select-0').change(e => {
        var semesterId = e.target.value;
        if (semesterId == 'Select Semester') return;
        $.ajax({
            url: `/user/${user.id}/settings/semester`,
            type: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({ semesterId }),
            success: function( data ) {
                $('#toastHeader').html('Success');
                $('#toastBody').html('Data updated!');
                $('#liveToast').toast('show');
            },
            fail: function( data ) {
                $('#toastHeader').html('Fail');
                $('#toastBody').html(data.message);
                $('#liveToast').toast('show');
            }
        })
    })
    
    $('#firstName').focusout(e => {
        buttonFocusOut('firstName')
        sendToServer();
    });
    
    $('#lastName').focusout(e => {
        buttonFocusOut('lastName')
        sendToServer();
    });

    $('#firstName').focusin(e => {
        buttonFocusIn('firstName')
    });

    $('#lastName').focusin(e => {
        buttonFocusIn('lastName')
    });


    var buttonFocusIn = (field) => {
        $(`#${field}`).removeClass('border-success')
        $(`#${field}`).removeClass('border-1')
        $(`#${field}`).addClass('border-warning')
        $(`#${field}`).addClass('border-3')
    }

    var buttonFocusOut = (field) => {
        $(`#${field}`).removeClass('border-warning')
        $(`#${field}`).removeClass('border-3')
        $(`#${field}`).addClass('border-success')
        $(`#${field}`).addClass('border-1')
    }

    var editOutcome = (field) => {
        $('#toastHeader').html('Success');
        $('#toastBody').html(`${field} updated!`);
        $('#liveToast').toast('show');
    }

    var sendToServer = () => {
        var firstName = $("#firstName").val().trim();
        var lastName = $("#lastName").val().trim();

        $.ajax({
            url: `/user/${user.id}/settings/`,
            type: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({ firstName, lastName }),
            success: function( data ) {
                if (data) {
                    $('#toastHeader').html('Success');
                    $('#toastBody').html('Data updated!');
                    $('#liveToast').toast('show');
                } else {
                    $('#toastHeader').html('Fail');
                    $('#toastBody').html('Unable to update profile');
                    $('#liveToast').toast('show');
            }},
            fail: function( data ) {
                $('#toastHeader').html('Fail');
                $('#toastBody').html(data.message);
                $('#liveToast').toast('show');
            }
        })
    }

    $('#submit').click(e => {
        var password = $("#password").val().trim();
        var newPassword = $("#newPassword").val().trim();
        var confirmedPassword = $("#confirmedPassword").val().trim();

        $.post(`/auth/changePassword`, { password, newPassword, confirmedPassword }, function( data, statusCode ) {
            $('#toastHeader').html(statusCode);
            $('#toastBody').html(data.message);
        }).fail((response, textStatus, errorThrown) => {
            $('#toastHeader').html(textStatus);
            $('#toastBody').html(`${errorThrown}-${JSON.parse(response.responseText).message}`);
        }).always(() => {
            $('#liveToast').toast('show');            
            $("#password").val('');
            $("#newPassword").val('');
            $("#confirmedPassword").val('');
            $("#password").focus();
        })
    })
</script>
