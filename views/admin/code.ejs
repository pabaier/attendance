<!-- requires courses list {id, course_number} -->
<%- include('partials/course-select-dropdown.ejs', {courses: courses}); %>
<!-- <button type="submit" id="add-class-btn" class="btn btn-primary my-2">Add Users To Course</button> -->

<div class="jumbotron">
    <h5 id="timer"></h5>
    <h1>Code</h1>
    <h1 id="number"></h1>


    <a class="btn btn-primary mt-5" data-bs-toggle="collapse" href="#users-collapse" role="button" aria-expanded="false" aria-controls="collapseExample">
        Users
    </a>

    <div class="collapse" id="users-collapse">
        <div class="container">
            <div class="row fs-4 fw-bold" id="user-count"></div>
            <div class="row my-2" id="users"></div>
        </div>
    </div>

<script type="application/javascript">
    var courses = <%-JSON.stringify(courses)%>
    var timerID = undefined;
    var displayCodeId = undefined;
    var displayUsersId = undefined;

    $('#course-select').change( (event) => {
        var courseId = event.target.value //$('#course-select').val()
        var course = courses.filter(course => course.id == courseId)
        try {
            var startTime = course[0].start_time.split(':')
        }
        catch {
            return;
        }
        var startHour = startTime[0]
        var startMinute = startTime[1]
        var today = new Date();
        var classDate = new Date();
        classDate.setHours(startHour);
        classDate.setMinutes(startMinute);
        classDate.setSeconds(0);
        var diffMilli = classDate - today;
        if (diffMilli > 0) {
            displayTimer(diffMilli, courseId);
        } else {
            if(timerID) clearInterval(timerID)
            if(displayCodeId) clearInterval(displayCodeId)
            if(displayUsersId) clearInterval(displayUsersId)
            $("#alert-box").html( 
                "<div class='alert alert-info' role='alert'>" + 
                    "Attendance Closed" +
                "</div>"
            )
            $("#number").html( "" )
            $("#timer").html('Class is done for today!');
        }       
    } )

    const displayTimer = (diffMilli, courseId) => {
        var diffDate = new Date(diffMilli)
            var minutesLeft = diffDate.getMinutes();
            var secondsLeft = diffDate.getSeconds();
            var codeStarted = false;
            timerID = setInterval(function () {
                var seconds = secondsLeft >= 10 ? secondsLeft : `0${secondsLeft}`;
                $("#timer").html(`${minutesLeft}:${seconds}`);
                secondsLeft -= 1;
                // start the code within 5 minutes of class starting
                if (minutesLeft < 5 && minutesLeft >= 0 && !codeStarted) {
                    codeStarted = true;
                    $("#alert-box").html( 
                        "<div class='alert alert-success' role='alert'>" + 
                            "Enter the last 5 numbers to sign in!" +
                        "</div>"
                    )
                    displayCodeId = displayCode();
                    displayUsersId = displayUsers(courseId);
                } else if (!codeStarted) {
                    $("#alert-box").html( 
                        "<div class='alert alert-warning' role='alert'>" + 
                            "Sign in will open 5 minutes before class starts" +
                        "</div>"
                    )
                }
                if (secondsLeft < 0) {
                    secondsLeft = 59;
                    minutesLeft -= 1;
                }

                // stop the time if class has started
                if (minutesLeft < 0) {
                    clearInterval(timerID)
                    clearInterval(displayCodeId)
                    clearInterval(displayUsersId)
                    codeStarted = false;
                    $("#alert-box").html( 
                        "<div class='alert alert-info' role='alert'>" + 
                            "Attendance Closed" +
                        "</div>"
                    )
                    $("#number").html( "" )
                }
            }, 1000);
    }

    const displayCode = () => {
        const interval = setInterval(function () {
            $.get( "/admin/code/update", function( data ) {
                if (data.code) {
                    $("#number").html( data.code )
                }
            })
        }, parseInt('<%= process.env.CODE_REFRESH_RATE %>'))
        return interval
    }

    const displayUsers = (courseId) => {
        const interval = setInterval(function () {
            $.get( `/admin/courses/${courseId}/signedin`, function( data ) {
                $('#users').html("");
                data.forEach(element => {
                    $('#users').append(
                        `
                            <div class="col-8 col-md-6 col-lg-4 col-xl-3 my-3 fs-4 fw-bold">
                                ${element.email.split('@')[0]}
                            </div>
                        `
                    );
                });
                $('#user-count').html(data.length)
            })
        }, 5000)
        return interval
    }
</script>